<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/account.js" defer></script>
    <title>Document</title>
</head>
<body>
    <canvas id="canvas" width="2000" height="2000"></canvas>
    <div id="highlight"></div>
    <div id="userHighlight"></div>

    <div id="interactive-zone"></div>
    <div id="palette"></div>

    <div id="cooldown"></div>

    <style>
        :root {
            --pixel-color: white;
            --pixel-border-size: calc(0.1 * var(--pixel-width));
            --zoom: 1;
            --pixel-width: calc(20px * var(--zoom));
        }

        #highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--pixel-width);
            height: var(--pixel-width);
            /* outline: var(--pixel-border-size) solid white; */
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            box-shadow: 0 0 10px 5px rgb(107, 107, 107);
            /* filter: drop-shadow(0 0 20px var(--pixel-color)); */
            outline: var(--pixel-border-size) solid var(--pixel-color);
            border-radius: calc(2px * var(--zoom));
            transition: transform 0.5s cubic-bezier(0,.83,.18,.99), opacity 0.2s cubic-bezier(0,.83,.18,.99);
        }

        .hidden#highlight {
            opacity: 0;
            transform: scale(0.5);
        }

        #userHighlight {
            position: absolute;
            top: 0;
            left: 0;
            margin-top: calc(var(--pixel-width) + 10px);
            text-shadow: 0 0 20px black, 0 0 10px black;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--pixel-width);

            pointer-events: none;
            color: white;
            font-size: 15px;
            font-family: sans-serif;
            padding: 2px;

            transition: opacity 0.1s ease, transform 0.1s ease;
        }

        #userHighlight.hidden {
            transform: scale(0.4);
            opacity: 0;
        }

        #canvas {
            image-rendering: pixelated;
            background: black;
            position: absolute;
            transform-origin: top left;
        }

        body {
            padding: 0;
            margin: 0;
            background: white;
            overflow: hidden;
        }

        .color {
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: 0.1s cubic-bezier(0,.57,.25,1);
        }

        .color:hover {
            filter: invert(0.2);
        }

        .color.selected {
            /* transform: scale(2); */
            /* margin: 0 25px; */
            width: 75px;
            z-index: 5;
        }

        #palette {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: auto;
            background: rgb(44, 42, 55);
            display: flex;
            z-index: 101;
            border-top: 3px solid rgb(50, 58, 97);
        }

        #interactive-zone {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
        }
        
        #cooldown {
            animation-timing-function: linear;
            position: fixed;
            top: 0;
            left: 0;
            /* width: 100vw; */
            height: 10px;
            background: rgb(44, 42, 55);
            border-bottom: 1px black;
        }

        @keyframes cooldown {
            0% {
                width: 100vw;
                opacity: 0;
            }

            10% {
                opacity: 1;
                width: 90vw;
            }

            95% {
                width: 5vw;
                opacity: 1;
                transform: scale(1);
            }

            100% {
                width: 0;
                opacity: 0;
            }
        }
    </style>

    <script>
        const userHighlight = document.getElementById("userHighlight");
        const highlight = document.getElementById("highlight");

        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const socket = io();

        var mouseX = 0;
        var mouseY = 0;

        var canvasWidth = 100;
        var canvasHeight = 100;
        var pixelSize = 20;

        function setSize(width, height) {
            canvasWidth = width;
            canvasHeight = height;

            canvas.width = canvasWidth * pixelSize;
            canvas.height = canvasHeight * pixelSize;
        }

        setSize(5, 5);

        socket.on('placeSize', (size) => {
            setSize(size.width, size.height);
        });

        window.addEventListener("mousemove", (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });
        
        var zoom = 1;
        var oldZoom = 1;
        
        function setZoom(newZoom) {
            oldZoom = zoom;
            zoom = newZoom;
            canvas.style.transform = `scale(${zoom})`;

            var x = pLeft * (zoom / oldZoom)
            var y = pTop * (zoom / oldZoom);


            setPosition(x, y);

            // Update pixel width in CSS variables
            document.styleSheets[0].rules[0].style.setProperty("--zoom", zoom);
        }

        setZoom(0.5);

        var pLeft = 0;
        var pTop = 0;

        function setPosition(x, y) {
            if (x < (window.innerWidth - (canvas.width * zoom)) - 100) x = (window.innerWidth - (canvas.width * zoom)) - 100;
            if (y < (window.innerHeight - (canvas.height * zoom)) - 150) y = (window.innerHeight - (canvas.height * zoom)) - 150;

            if (x > 100) x = 100;
            if (y > 100) y = 100;

            pLeft = x;
            pTop = y;

            canvas.style.left = x + "px";
            canvas.style.top = y + "px";
        }

        window.addEventListener("resize", (e) => {
            setPosition(pLeft, pTop);
        });

        socket.on("place", (a) => {
            placePixel(a);
            pixels[a.x + "," + a.y] = a;
        });

        socket.on("places", (a) => {
            a.forEach((pixel) => {
                placePixel(pixel);
                pixels[pixel.x + "," + pixel.y] = pixel;
            });
        });

        var pixelX = 0;
        var pixelY = 0;


        var colors = [ ];
        socket.on("colors", (c) => {
            colors = c;
            createPalette();
            placePixels();
        });

        var pixels = { };
        function placePixels() {
            for (var i in pixels)
                placePixel(pixels[i]);
        }

        var palette = document.getElementById("palette");
        var color = 0;

        function createPalette() {
            palette.innerHTML = "";
            for (var i = 0; i < colors.length; i++) {
                var cc = colors[i];
    
                var div = document.createElement("div");
                div.className = "color " + ((i == 0) ? "selected" : "");
    
                div.style.backgroundColor = cc;
                div.setAttribute("data-color", i);
    
                div.addEventListener("click", (e) => {
                    color = e.target.attributes["data-color"].value;
                    document.styleSheets[0].rules[0].style.setProperty("--pixel-color", e.target.style.backgroundColor);
                    $(".color").removeClass("selected");
                    e.target.classList.add("selected");
                });
    
                palette.appendChild(div);
            }
        }

        var interactiveZone = document.getElementById("interactive-zone");
        var timeout = null;
        var timeoutX = null;
        var timeoutY = null;

        interactiveZone.addEventListener("pointermove", (e) => {
            var realPixelSize = pixelSize * zoom;
            pixelX = Math.floor((e.clientX - canvas.offsetLeft) / realPixelSize);
            pixelY = Math.floor((e.clientY - canvas.offsetTop) / realPixelSize);

            if (pixelX >= canvasWidth || pixelY >= canvasHeight || pixelX < 0 || pixelY < 0) {
                highlight.classList.add("hidden");
                return;
            } else {
                highlight.classList.remove("hidden");
                highlight.style.left = ((pixelX * realPixelSize) + canvas.offsetLeft) + "px";
                highlight.style.top = ((pixelY * realPixelSize) + canvas.offsetTop) + "px";
            }

            if (timeout && (timeoutX == pixelX && timeoutY == pixelY)) {
                return;
            }

            if (timeout)
                clearTimeout(timeout);

            timeoutX = pixelX;
            timeoutY = pixelY;

            userHighlight.classList.add("hidden");

            timeout = setTimeout(() => {
                socket.emit("getPixelOwner", { x: pixelX, y: pixelY }, (res) => {
                    if (res.error) {
                        console.log(res);
                        if (res.error.includes("logged in")) location.href = '/login';
                        return;
                    }
    
                    if (!res.owner) {
                        userHighlight.classList.add("hidden");
                        return;
                    }
                    
                    userHighlight.classList.remove("hidden");
                    userHighlight.style.left = ((pixelX * realPixelSize) + canvas.offsetLeft) + "px";
                    userHighlight.style.top = ((pixelY * realPixelSize) + canvas.offsetTop) + "px";
                    userHighlight.innerHTML = res.owner.username;
                });
            }, 1000);
        });
        
        var cooldown = 5;

        socket.on('cooldown', (c) => {
            cooldown = c;
        });

        interactiveZone.addEventListener("pointerdown", (e) => {
            if (e.button != 0) return;

            var mouseMoveDist = 0;
            var mouseDownStart = Date.now();

            function mouseUp(e) {
                mouseLeave();

                if (Math.abs(mouseMoveDist) > 20) return;
                if (Date.now() - mouseDownStart > 300) return;

                socket.emit("place", {
                    x: pixelX, y: pixelY, color: color
                }, (res) => {
                    if (res.error) {
                        console.log(res);
                        if (res.error.includes("logged in")) location.href = '/login';
                        return;
                    }
    
                    console.log("Place res", res);
    
                    var coolEl = document.getElementById("cooldown");
                    coolEl.style.animation = 'none';
                    coolEl.offsetHeight;
                    coolEl.style.animation = null;
    
                    coolEl.style.animation = `cooldown ${cooldown}s linear`;
                });
            }

            function mouseLeave() {
                document.removeEventListener("pointermove", mouseMove);
                interactiveZone.removeEventListener("pointerup", mouseUp);
                $(interactiveZone).off("pointerleave", mouseLeave);
            }

            var startX = e.clientX;
            var startY = e.clientY;
            var startOffsetX = canvas.offsetLeft;
            var startOffsetY = canvas.offsetTop;
            
            // move the canvas's left/top to drag
            function mouseMove(e) {
                mouseMoveDist += Math.sqrt(Math.pow(e.clientX - startX, 2) + Math.pow(e.clientY - startY, 2));
                
                var x = e.clientX - startX;
                var y = e.clientY - startY;

                var cLeft = (startOffsetX + x);
                var cTop = (startOffsetY + y);

                setPosition(cLeft, cTop);
            }

            document.addEventListener("pointermove", mouseMove);
            interactiveZone.addEventListener("pointerup", mouseUp);
            $(interactiveZone).on("pointerleave", mouseLeave);
        });

        interactiveZone.addEventListener("pointerleave", (e) => {
            highlight.classList.add("hidden");
        });

        function placePixel(pixel) {
            ctx.fillStyle = colors[pixel.color];
            ctx.fillRect(pixel.x * pixelSize, pixel.y * pixelSize, pixelSize, pixelSize);
        }

        document.addEventListener("wheel", (e) => {
            if (e.deltaY > 0 && zoom > 0.25) {
                setZoom(zoom - 0.1);
            } else if (e.deltaY < 0 && zoom < 5) {
                setZoom(zoom + 0.1);
            }
        });

    </script>
</body>
</html>